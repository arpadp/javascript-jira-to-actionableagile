<html>
<head>
	<style type="text/css">
		textarea {
			border : 1 black;
			overflow: hidden;
			padding: 0;
			outline: none;
			background-color: rgba(231, 192, 19, 0.692);
			resize: none;
			width: 400px;
			height: 100px;
		}
		</style>
    <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script>

	
	var worklfowSteps = [];
	//Some teams may use dev done status as end date, but people may push directly to done. This helps to have these stories closed as well.
	const overrideDevDoneDateWithDevDateWhenDevDoneDateIsNull = true;

    $( document ).ready(function() {
        console.log( "document loaded" );

        $( "#btnDownload" ).click(function() {
  		
			var inputJsonFileLocation = $("#inputJsonFileLocation").val();
			var inputJson = $("#inputJson").val();	
			getWorkflowSteps();			

			if(inputJsonFileLocation != ""){
				var request = new XMLHttpRequest();
				request.open("GET",inputJsonFileLocation, false);
				request.send(null)
				var linkJsonObj = JSON.parse(request.responseText);
				var fromatedObj = formatJson(linkJsonObj);						
				exportCSVFile(fromatedObj.issues,"Data");
				
			}else{
					var jsonObj = jQuery.parseJSON(inputJson);
				if(!isValidJson(jsonObj)){
						alert("Invalid Json"); 
				}
				else{
						var fromatedObj = formatJson(jsonObj);						
						exportCSVFile(fromatedObj.issues,"Data");
				}
			}

		});
    });

	function getWorkflowSteps(){
		var inputWorkflow = $("#inputWorkflow").val();	
		worklfowSteps = inputWorkflow.split(',');
	}

	function formatJson(jsonObj){
		
		var fromatedObj = JSON.parse(getSkeletonJsonFormated()); 
		for (var i = 0; i < jsonObj.issues.length; i++){
			var histories = jsonObj.issues[i].changelog.histories;
			
			var id = jsonObj.issues[i].key;
			var summary = removeCommas(jsonObj.issues[i].fields.summary);
			var type = removeCommas(jsonObj.issues[i].fields.issuetype.name);

			var workflowValues = [];
			for(var j=0;j<worklfowSteps.length;j++){
				workflowValues.push(getDateByStatus(histories,worklfowSteps[j]));
			}

			var itemToPush = getItemToPush(id,summary,workflowValues,type,histories);
			fromatedObj['issues'].push(itemToPush);
			
		}
		return fromatedObj;
	}

	function getSkeletonJsonFormated(){
		var skeletonJSON = '{"issues":[{"Id":"Id","Name":"Name", ';
		
		for (var i = 0; i < worklfowSteps.length; i++){
			skeletonJSON = skeletonJSON + '"'+ worklfowSteps[i] +'":"'+ worklfowSteps[i] +'",';

		}

		skeletonJSON = skeletonJSON + '"Type":"Type" }]}';

		return skeletonJSON;
	}

	function getItemToPush(id,name,workflowStepsValue,type,histories){
		//The order should be Id, Name, [Steps],Type to be accepted by actionableagile
		var item = {};
		item["Id"] = id;
		item["Name"] = name;

		for(var i=0;i<worklfowSteps.length;i++){

			if(!overrideDevDoneDateWithDevDateWhenDevDoneDateIsNull){
				item[worklfowSteps[i]] = workflowStepsValue[i];
			}else{
				if(worklfowSteps[i] == "Dev Done"){
					var endDate = workflowStepsValue[i];
					if(endDate == ""){
						endDate = getDateByStatus(histories,"Waiting for Release");
					}
					if(endDate == ""){
						endDate = getDateByStatus(histories,"Done");	
					}
					
					item[worklfowSteps[i]] = endDate;
					
				}
				else{
					item[worklfowSteps[i]] = workflowStepsValue[i];
				}
			}


			
		}

		item["Type"] = type; 

		return item;
	}



	function removeCommas(str){
		return str.replace(",", " ");
	}

	function getDateByStatus(histories, toStatus){
		for (var i = 0; i < histories.length; i++){
				if(histories[i].items[0].toString == toStatus){
					return histories[i].created;
				}
			}
		return "";	
	}

	function ConvertToCSV(objArray) {
            var array = typeof objArray != 'object' ? JSON.parse(objArray) : objArray;
            var str = '';

            for (var i = 0; i < array.length; i++) {
                var line = '';
                for (var index in array[i]) {
                    if (line != '') line += ','

                    line += array[i][index];
                }

                str += line + '\r\n';
            }

            return str;
    }

	function exportCSVFile(jsonObject, fileTitle) {
		
		var csv = ConvertToCSV(jsonObject);

		var exportedFilenmae = fileTitle + '.csv' || 'export.csv';

		var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
		if (navigator.msSaveBlob) { // IE 10+
			navigator.msSaveBlob(blob, exportedFilenmae);
		} else {
			var link = document.createElement("a");
			if (link.download !== undefined) { // feature detection
				// Browsers that support HTML5 download attribute
				var url = URL.createObjectURL(blob);
				link.setAttribute("href", url);
				link.setAttribute("download", exportedFilenmae);
				link.style.visibility = 'hidden';
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
			}
		}
	}


    function isValidJson(jsonObj) {
		try {
		if(typeof jsonObj != 'undefined' && typeof jsonObj.issues != 'undefined' && typeof jsonObj.issues[0].key != 'undefined' && jsonObj.issues[0].key.startsWith("HOP-")){
			return true;
		}
		return false;
		}
		catch{
			return false;
		}

	}


    </script>
</head>
<body>
	<table>
		<tr>
			<td>Step 1: Setup the jira workflow. These must be the exact statuses from jira sperated by comma like on the default example</td>
			<td><textarea id="inputWorkflow">Analysis in progress,Waiting for Dev,Dev In Progress,Waiting for Code Review,Code Review In Progress,Dev Done</textarea></td>
		</tr>
		<tr>
			<td>Step 2: Get the json from the jira instance</td>
			<td><a href="https://jiraserver.com/rest/api/latest/search?jql=filter=30347&expand=changelog&maxResults=150" target="_blank">Get the jira data</a></td>
		</tr>
		<tr>
			<td>Step 3: Fill in the json</td>
			<td><textarea id="inputJson" maxlength="16000000"></textarea></td>
			<td>Or give the link to the json file for large files</td>
			<td><textarea id="inputJsonFileLocation"></textarea></td>
		</tr>
		<tr>
			<td>Step 4: Get the csv formated for analytics.actionableagile.com</td>
			<td><button id="btnDownload">Click to download</button></td>
		</tr>
	</table>
	
</body>
</html>